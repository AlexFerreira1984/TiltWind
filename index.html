<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TiltWind BLE Monitor v12</title>
    <script>
        let device, server, txChar, rxChar;
        let historyData = "";

        async function connectToTiltWind() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: false,
                    filters: [{ name: "TiltWind" }],
                    optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
                });

                server = await device.gatt.connect();
                const service = await server.getPrimaryService("12345678-1234-1234-1234-1234567890ab");

                txChar = await service.getCharacteristic("12345678-1234-1234-1234-1234567890ac");
                rxChar = await service.getCharacteristic("12345678-1234-1234-1234-1234567890ad");

                txChar.startNotifications();
                txChar.addEventListener("characteristicvaluechanged", handleNotification);

                document.getElementById("status").innerText = "Connected!";
            } catch (error) {
                console.error("BLE Error:", error);
            }
        }

        function handleNotification(event) {
            let value = new TextDecoder().decode(event.target.value);
            console.log("Received:", value);

            if (value.startsWith("HISTORY:")) {
                historyData += value.replace("HISTORY:", "").trim() + "\n";
            } else if (value === "MORE") {
                sendCommand("H");
            } else if (value === "END") {
                document.getElementById("historyBox").innerText = historyData;
                historyData = "";
            } else {
                document.getElementById("windData").innerText = value;
            }
        }

        async function sendCommand(cmd) {
            if (rxChar) {
                await rxChar.writeValue(new TextEncoder().encode(cmd));
                console.log("Sent command:", cmd);
            }
        }

        function requestHistory() {
            historyData = "";
            sendCommand("H");
        }
    </script>
</head>
<body>
    <h1>TiltWind BLE Monitor v12</h1>

    <button onclick="connectToTiltWind()">Connect</button>
    <button onclick="requestHistory()">Request History</button>

    <div id="status">Disconnected</div>
    
    <h2>Live Wind Data:</h2>
    <div id="windData"></div>

    <h2>History Log:</h2>
    <pre id="historyBox"></pre>

</body>
</html>
